# 2 品果微服务框架研发概览

品果微服务框架即“PGWireless Micro Service Framework For PHP”，是Camera360服务器端现代化的PHP服务框架，简称msf或者php-msf，它的核心设计思想是采用协程、异步、并行的创新技术手段提高系统的单机吞吐能力，降低整体服务器成本。

## 主要特性

* 精简版的MVC框架
* IO密集性业务的单机处理能力提升5-10倍
* 代码长驻内存
* 支持对象池
* 支持各种连接池（Redis分布式、master-slave部署结构）
* 支持异步、并行
* 基于PHP yield实现协程
* 内建tcp/http/redis/mysql/mongodb/task等协程客户端
* 原生支持Tcp/Http Server
* RPC Server/Client

## 社区首页重构

### 软硬件

* aws c3.xlarge（4核8G）
* 64个php-fpm进程

### 处理逻辑

* 1次Redis Get
* 1次 MongoDB Query
* 2个广告接口
* 2个社区接口

### 重构前

PHP-5.6/Yii2/OPcache/Http

   n   |   c   |     qps    | 平均响应时间(ms) |  CPU  |
-------|-------|------------|-----------------|-------|
   100 |   1   |       4.16 |      240.168    |    9% |
  5000 |   5   |      15.36 |      325.502    |   46% |
  5000 |  10   |      18.72 |      534.141    |   83% |
  5000 |  50   |      19.03 |     2627.159    |   99% |

PHP-7.0/Yii2/OPcache/Http

   n   |   c   |     qps    | 平均响应时间(ms) |  CPU  |
-------|-------|------------|-----------------|-------|
   100 |   1   |       3.51 |      284.876    |    5% |
  5000 |   5   |      17.23 |      290.129    |   21% |
  5000 |  10   |      32.36 |      309.057    |   40% |
  5000 |  20   |      52.94 |      377.784    |   82% |
  5000 |  40   |      55.52 |      720.433    |   91% |

### 重构后

msf-2.0

   n   |   c   |     qps    | 平均响应时间(ms) |  CPU  |
-------|-------|------------|-----------------|-------|
   100 |   1   |       4.52 |      221.089    |  1.4% |
  5000 |   5   |      40.31 |      248.063    |   14% |
  5000 |  10   |      73.22 |      273.148    |   27% |
  5000 |  20   |     129.63 |      308.575    |   75% |
  5000 |  40   |     172.19 |      475.916    |   99% |

### 资源使用

![CPU使用](./images/hotpot-cpu.jpg "CPU使用")

在处理相同并发请求下，上面的曲线是重构前的，下面的曲线是重构后的。

### 结论

1. 采用新框架重构首页服务后，在相同资源消耗的情况下，单机的处理能力提升8倍；
2. 重构前首页在正常情况下，提供15qps，CPU使用率为45%左右；
3. 重构后首页在正常情况下，提供15qps，CPU使用率为12%左右；
4. 重构后首页单机正常情况下，提供120qps，CPU使用率为75%左右；

# links
  * [目录](<preface.md>)
  * 上一节: [第一章小结](<01.4.md>)
  * 下一节: [新框架研发目标](<02.1.md>)